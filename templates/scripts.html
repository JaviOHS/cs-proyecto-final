{% load static %}
<script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
<script src="{% static 'js/img.js' %}"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<!-- Script para inicializar AOS -->
<script>
  AOS.init();
</script>

<!-- Pantallazo blanco al cambiar de pagina -->
<script>
  (function () {
    const isDarkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
    if (isDarkModeEnabled) {
      document.documentElement.classList.add('dark');
    }
    document.documentElement.classList.add('loaded');
  })();
  (function () {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.className = savedTheme;
    document.documentElement.classList.add('loaded');
  })();
</script>

<!-- Script para alertas -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const messages = document.querySelectorAll('#message-container > div');
    messages.forEach(function (message) {
      setTimeout(function () {
        message.style.transition = 'opacity 0.5s ease-out';
        message.style.opacity = '0';
        setTimeout(function () {
          message.remove();
        }, 500);
      }, 5000);
    });
  });
</script>

<!-- Script para cambiar el tema -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const themeToggleBtn = document.getElementById('themeIconContainer');
    const themeIcon = document.getElementById('themeIcon');

    // Funci√≥n para cambiar el √≠cono del tema
    function toggleThemeIcon() {
      if (themeIcon) {
        if (document.documentElement.classList.contains('dark')) {
          themeIcon.classList.remove('fa-moon');
          themeIcon.classList.add('fa-sun');
        } else {
          themeIcon.classList.remove('fa-sun');
          themeIcon.classList.add('fa-moon');
        }
      }
    }

    // Funci√≥n para aplicar un tema y actualizar el √≠cono
    function setTheme(theme) {
      document.documentElement.className = theme;
      localStorage.setItem('theme', theme); // Guarda el tema seleccionado en localStorage para persistencia

      // Mostrar u ocultar la imagen de fondo seg√∫n el tema seleccionado (si es necesario)
      const heroSection = document.getElementById('hero-section');
      if (heroSection) {
        if (theme === 'theme1') {
          heroSection.classList.remove('no-background');
        } else {
          heroSection.classList.add('no-background');
        }
      }

      // Cambia el √≠cono del tema
      toggleThemeIcon();
    }

    // Verifica si hay un tema guardado en el almacenamiento local
    const savedTheme = localStorage.getItem('theme') || 'light';
    setTheme(savedTheme);

    // Cambiar el √≠cono del tema al cargar la p√°gina
    toggleThemeIcon();

    // Agrega un listener para el evento 'click' en el bot√≥n
    if (themeToggleBtn) {
      themeToggleBtn.addEventListener('click', function (event) {
        event.preventDefault(); // Previene el comportamiento predeterminado del √≠cono
        // Cambia entre temas light y dark
        if (document.documentElement.classList.contains('dark')) {
          setTheme('light');
        } else {
          setTheme('dark');
        }
      });
    }

    // Exponer setTheme globalmente para usarlo en el men√∫ de temas
    window.setTheme = setTheme;
  });
</script>

<!-- Script para hacer blur la navbar -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const navbar = document.getElementById('navbar');

    if (navbar) {
      window.addEventListener('scroll', () => {
        const isDarkMode = document.documentElement.classList.contains('dark'); // Verifica si el modo oscuro est√° activado

        if (window.scrollY > 50) {
          navbar.classList.add('bg-opacity-80', 'backdrop-blur-sm');
          if (isDarkMode) {
            navbar.classList.add('dark:bg-opacity-80', 'dark:backdrop-blur-sm');
          }
        } else {
          navbar.classList.remove('bg-opacity-80', 'backdrop-blur-sm');
          if (isDarkMode) {
            navbar.classList.remove('dark:bg-opacity-80', 'dark:backdrop-blur-sm');
          }
        }
      });
    }
  });
</script>

<!-- Script para el bot√≥n de ir arriba -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    window.addEventListener('scroll', function () {
      var goTopBtn = document.getElementById('goTopBtn');
      if (window.scrollY > 100) {
        goTopBtn.classList.remove('translate-y-20');
        goTopBtn.classList.remove('opacity-0');
        goTopBtn.classList.add('translate-y-0');
        goTopBtn.classList.add('opacity-100');
      } else {
        goTopBtn.classList.add('translate-y-20');
        goTopBtn.classList.add('opacity-0');
        goTopBtn.classList.remove('translate-y-0');
        goTopBtn.classList.remove('opacity-100');
      }
    });

    document.getElementById('goTopBtn').addEventListener('click', function () {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });
</script>

<!-- SCRIPTS QUE ESTABAN EN HOME -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<!-- Modal Sobre Nosotros -->
<script>
  document.querySelectorAll('[data-modal-target]').forEach(button => {
    button.addEventListener('click', () => {
      const modal = document.getElementById(button.getAttribute('data-modal-target'));
      modal.classList.remove('hidden');

      // Recalcula la posici√≥n centrada del modal
      const modalContent = modal.querySelector('.relative.bg-white');
      const modalHeight = modalContent.clientHeight;
      const windowHeight = window.innerHeight;
      const topOffset = (windowHeight - modalHeight) / 2;

      modalContent.style.marginTop = `${topOffset}px`;
    });
  });

  document.querySelectorAll('[data-modal-hide]').forEach(button => {
    button.addEventListener('click', () => {
      const modal = button.closest('.fixed');
      modal.classList.add('hidden');

      // Restablece la posici√≥n del modal
      const modalContent = modal.querySelector('.relative.bg-white');
      modalContent.style.marginTop = `0`;
    });
  });
</script>

<!-- Boton de accesibilidad -->
<style>
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.7);
    }

    70% {
      box-shadow: 0 0 0 15px rgba(66, 153, 225, 0);
    }

    100% {
      box-shadow: 0 0 0 0 rgba(66, 153, 225, 0);
    }
  }

  #dropdownDefaultButton {
    animation: pulse 2s infinite;
    position: fixed;
    bottom: 140px;
    /* Movido m√°s arriba */
    left: 32px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #dropdown {
    position: fixed;
    bottom: 200px;
    /* Posicionado encima del bot√≥n */
    left: 32px;
    transform: translateY(10px);
    opacity: 0;
    visibility: hidden;
    transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s;
  }

  #dropdown.show {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
  }
</style>

<!-- Dropdown -->
<script>
  const button = document.getElementById('dropdownDefaultButton');
  const dropdown = document.getElementById('dropdown');

  button.addEventListener('click', () => {
    dropdown.classList.toggle('show');
  });

  // Cerrar el dropdown si se hace clic fuera de √©l
  document.addEventListener('click', (event) => {
    if (!button.contains(event.target) && !dropdown.contains(event.target)) {
      dropdown.classList.remove('show');
    }
  });

  // Funciones para controlar el zoom
  let currentZoom = 100;

  function changeZoom(direction) {
    if (direction === 'in') {
      currentZoom += 10;
    } else if (direction === 'out') {
      currentZoom -= 10;
    }
    currentZoom = Math.max(50, Math.min(currentZoom, 200)); // Limitar entre 50% y 200%
    document.body.style.zoom = `${currentZoom}%`;
  }

  function resetZoom() {
    currentZoom = 100;
    document.body.style.zoom = '100%';
  }
</script>

<!-- Script para la barra de progreso -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let progressBar = document.getElementById('progress-bar');

    // Se ejecuta solo si est√° presente en la p√°gina
    if (progressBar) {
      let totalHeight = document.documentElement.scrollHeight - window.innerHeight;

      window.addEventListener('scroll', function () {
        let progress = (window.pageYOffset / totalHeight) * 100;
        progressBar.style.width = progress + '%';
      });

      window.addEventListener('resize', function () {
        totalHeight = document.documentElement.scrollHeight - window.innerHeight;
      });
    }
  });

</script>

<!-- Script para cerrar la sesi√≥n -->
<script>
  document.addEventListener('keydown', function (event) {
    // Detecta Ctrl + Espacio como combinaci√≥n de teclas para cerrar sesi√≥n
    if (event.ctrlKey && event.code === 'Space') {
      // Acci√≥n de cierre de sesi√≥n
      logoutUser();
    }
  });

  function logoutUser() {
    // Redirige al usuario a la URL de cierre de sesi√≥n
    window.location.href = "{% url 'security:signout' %}";
  }
</script>

<!-- Script Chatbot -->
<script type="module">
  import { CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm"

  const $ = el => document.querySelector(el)
  const $openChat = $('#open-chat')
  const $closeChat = $('#close-chat')
  const $chatbot = $('#chatbot')
  const $chatMessages = $('#chat-messages')
  const $chatInput = $('#chat-input')
  const $sendMessage = $('#send-message')
  const $modelSelection = $('#model-selection')
  const $currentModel = $('#current-model')
  const $selectedModelDiv = $('#selected-model')

  let messages = []
  let engine = null
  let jsonData = []
  let isEngineInitializing = false
  let selectedModel = null

  // Cargar los datos del JSON
  async function loadJSONData() {
    if (jsonData.length === 0) {
      try {
        const response = await fetch('/static/chatbot_training_data.json');
        jsonData = await response.json();
      } catch (error) {
        console.error('Error loading JSON data:', error);
      }
    }
  }

  // Buscar una respuesta en el JSON
  function findAnswerInJSON(question) {
    const lowerQuestion = question.toLowerCase();
    const match = jsonData.find(item =>
      lowerQuestion.includes(item.question.toLowerCase())
    );
    return match ? match.answer : null;
  }

  // Inicializar el chatbot y cargar el modelo
  async function initializeChatbot() {
    await loadJSONData();
  
    $modelSelection.classList.add('hidden');
  
    // Resetea el modelo mostrado
    $currentModel.textContent = 'Ninguno';
  
    selectedModel = await showModelOptions();
    
    // Opciones principales del men√∫
    const mainMenuOptions = [
      "¬øQui√©n eres?",
      "Informaci√≥n sobre autenticaci√≥n",
      "Informaci√≥n sobre el sistema",
      "Perfil del Usuario",
      "Informaci√≥n sobre alertas",
      "Informaci√≥n sobre monitoreo",
      "Informaci√≥n sobre reportes"
    ];
  
    // Mensaje de bienvenida personalizado con emojis relevantes
    const welcomeMessage = [
      "¬°Hola üëã! Soy Alexis, tu ChatBot personal.",
      "Estoy aqu√≠ para ayudarte con cualquier duda al momento de usar nuestro software.",
      "¬øEn qu√© puedo ayudarte üòä?"
    ].join("\n");
  
    await addMessageWithOptions(
      welcomeMessage,
      mainMenuOptions,
      'bot'
    );
  
    // Peque√±a pausa para mejor experiencia de usuario
    await new Promise(resolve => setTimeout(resolve, 1000));
  
  
    enableChat();
  }

  // Nueva funci√≥n para crear una opci√≥n seleccionable
  function createOption(text) {
    const option = document.createElement('div');
    option.className = 'text-center text-sm text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 my-2 py-2 rounded-lg mx-4 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200';
    option.innerHTML = `<span>${text}</span>`;
    
    option.addEventListener('click', async () => {
      // Agregar la selecci√≥n como mensaje del usuario
      await addMessage(text, 'user');
      
      // Procesar la respuesta basada en la opci√≥n seleccionada
      handleOptionSelection(text);
    });
    
    return option;
  }

  // Nueva funci√≥n para agregar mensaje con opciones
  async function addMessageWithOptions(text, options = [], sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col');

    if (sender === 'bot') {
      messageElement.classList.add(
        'bg-gray-100',
        'dark:bg-[#0f1e41]',
        'mr-auto',
        'px-4',
        'py-2',
        'rounded-lg',
        'w-full',
        'max-w-[80%]',
        'font-semibold'
      );

      const botTextElement = document.createElement('p');
      botTextElement.classList.add('text-sm');
      messageElement.appendChild(botTextElement);

      $chatMessages.appendChild(messageElement);
      await typeMessage(botTextElement, text);

      // Agregar opciones despu√©s del mensaje
      if (options.length > 0) {
        const optionsContainer = document.createElement('div');
        optionsContainer.classList.add('mt-4');
        options.forEach(optionText => {
          optionsContainer.appendChild(createOption(optionText));
        });
        $chatMessages.appendChild(optionsContainer);
      }
    } else {
      messageElement.classList.add(
        'bg-blue-700',
        'dark:bg-indigo-700',
        'text-white',
        'ml-auto',
        'inline-block',
        'px-4',
        'py-2',
        'rounded-lg',
        'max-w-[60%]',
        'text-left',
        'font-semibold'
      );
      messageElement.innerHTML = `<p class="text-sm">${text}</p>`;
      $chatMessages.appendChild(messageElement);
    }

    $chatMessages.scrollTop = $chatMessages.scrollHeight;
  }

  // Nueva funci√≥n para manejar la selecci√≥n de opciones
  async function handleOptionSelection(option) {
    let response;
    let nextOptions = [];
  
    switch (option) {
      // Men√∫ Principal
      case "Volver al men√∫ principal":
        response = "¬øEn qu√© m√°s puedo ayudarte?";
        nextOptions = [
          "¬øQui√©n eres?",
          "Informaci√≥n sobre autenticaci√≥n",
          "Informaci√≥n sobre el sistema",
          "Perfil del Usuario",
          "Informaci√≥n sobre alertas",
          "Informaci√≥n sobre monitoreo",
          "Informaci√≥n sobre reportes"
        ];
        break;
      // Perfil del Usuario (Nueva secci√≥n)
      case "Perfil del Usuario":
        response = "¬øQu√© te gustar√≠a saber sobre tu perfil de usuario?";
        nextOptions = [
          "Informaci√≥n personal",
          "Preferencias del sistema",
          "Permisos y roles",
          "Volver al men√∫ principal"
        ];
        break;

      case "Informaci√≥n personal":
        response = "¬øQu√© informaci√≥n personal necesitas gestionar?";
        nextOptions = [
          "¬øC√≥mo actualizo mis datos personales?",
          "¬øPuedo cambiar mi correo electr√≥nico?",
          "Volver al men√∫ principal"
        ];
        break;

      case "Preferencias del sistema":
        response = "¬øQu√© preferencias del sistema te gustar√≠a configurar?";
        nextOptions = [
          "¬øC√≥mo cambio el tema de la interfaz?",
          "Volver al men√∫ principal"
        ];
        break;

      case "Permisos y roles":
        response = "¬øQu√© necesitas saber sobre tus permisos y roles?";
        nextOptions = [
          "¬øQu√© permisos tengo actualmente?",
          "¬øC√≥mo solicito permisos adicionales?",
          "¬øCu√°les son los diferentes roles disponibles?",
          "Volver al men√∫ principal"
        ];
      break;
      // Autenticaci√≥n
      case "Informaci√≥n sobre autenticaci√≥n":
        response = "Tenemos varias opciones de autenticaci√≥n. ¬øQu√© te gustar√≠a conocer?";
        nextOptions = [
          "M√©todos de autenticaci√≥n disponibles",
          "Gesti√≥n de contrase√±a",
          "Configuraci√≥n de perfil",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "M√©todos de autenticaci√≥n disponibles":
        response = "El sistema ofrece registro y login tradicionales, reconocimiento facial, y gesti√≥n de contrase√±as.";
        nextOptions = [
          "¬øTengo que usar contrase√±a siempre?",
          "¬øC√≥mo funciona el reconocimiento facial?",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Gesti√≥n de contrase√±a":
        response = "¬øQu√© necesitas saber sobre la gesti√≥n de tu contrase√±a?";
        nextOptions = [
          "¬øC√≥mo cambio mi contrase√±a?",
          "¬øQu√© pasa si me roban el celular? ¬øPueden entrar a mi cuenta?",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Configuraci√≥n de perfil":
        response = "¬øQu√© te gustar√≠a configurar en tu perfil?";
        nextOptions = [
          "¬øQu√© opciones tienen los usuarios en su perfil?",
          "Oye, ¬øy si quiero cambiar mi foto de perfil?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Sistema
      case "Informaci√≥n sobre el sistema":
        response = "¬øQu√© aspecto del sistema te gustar√≠a conocer?";
        nextOptions = [
          "Rendimiento y acceso",
          "Configuraci√≥n general",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Rendimiento y acceso":
        response = "¬øQu√© informaci√≥n necesitas sobre el rendimiento y acceso?";
        nextOptions = [
          "¬øQu√© tan r√°pido funciona todo esto?",
          "¬øPuedo usar esto desde mi celular?",
          "Todo esto suena genial, pero ¬øqu√© pasa si se va la luz?",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Configuraci√≥n general":
        response = "¬øQu√© necesitas saber sobre la configuraci√≥n?";
        nextOptions = [
          "¬øQu√© tan dif√≠cil es configurar todo esto?",
          "¬øEsto funciona solo para empresas grandes?",
          "¬øQu√© pasa con las actualizaciones? ¬øTengo que hacer algo?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Alertas
      case "Informaci√≥n sobre alertas":
        response = "¬øQu√© te gustar√≠a saber sobre nuestro sistema de alertas?";
        nextOptions = [
          "Tipos de amenazas",
          "Configuraci√≥n de alertas",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Tipos de amenazas":
        response = "¬øQu√© informaci√≥n necesitas sobre las amenazas?";
        nextOptions = [
          "¬øC√≥mo detecta el sistema comportamientos sospechosos?",
          "Eso de las amenazas suena intenso. ¬øQu√© tipo de cosas detecta el sistema?",
          "Me da cosa eso de las amenazas. ¬øC√≥mo s√© si est√° pasando algo raro?",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Configuraci√≥n de alertas":
        response = "¬øQu√© necesitas saber sobre la configuraci√≥n de alertas?";
        nextOptions = [
          "¬øC√≥mo configuro una alerta personalizada?",
          "¬øQu√© tipos de alertas ofrece el sistema?",
          "¬øY si quiero que me avise de algo espec√≠fico?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Monitoreo
      case "Informaci√≥n sobre monitoreo":
        response = "¬øQu√© te gustar√≠a saber sobre el monitoreo?";
        nextOptions = [
          "¬øC√≥mo creo una nueva sesi√≥n de monitoreo?",
          "¬øPuedo ver lo que est√° pasando en tiempo real?",
          "¬øY si pasa algo cuando no estoy mirando?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Reportes
      case "Informaci√≥n sobre reportes":
        response = "¬øQu√© informaci√≥n necesitas sobre los reportes?";
        nextOptions = [
          "Me interesa eso de las estad√≠sticas. ¬øQu√© tipo de info puedo ver?",
          "¬øPuedo compartir los reportes con mi equipo?",
          "Esto de la privacidad... ¬ømis datos est√°n seguros?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Identificaci√≥n
      case "¬øQui√©n eres?":
        response = "Hola, soy Alexis, el asistente personal de la empresa PASYS ALERTE, mi misi√≥n es responder cualquier duda que tengas al momento de usar nuestro Software üòä.";
        nextOptions = [
          "¬øY si necesito ayuda con algo?",
          "Volver al men√∫ principal"
        ];
        break;
  
      default:
        // Buscar en el JSON de respuestas
        const jsonResponse = findAnswerInJSON(option);
        if (jsonResponse) {
          response = jsonResponse;
        } else {
          response = "¬øHay algo m√°s en lo que pueda ayudarte?";
        }
        nextOptions = ["Volver al men√∫ principal"];
    }
  
    // Esperar un momento antes de mostrar la respuesta
    await new Promise(resolve => setTimeout(resolve, 500));
    await addMessageWithOptions(response, nextOptions, 'bot');
  }

  // Funci√≥n para mostrar opciones de modelo
  function showModelOptions() {
    return new Promise((resolve) => {
      $modelSelection.classList.remove('hidden');

      const modelOptions = $modelSelection.querySelectorAll('.model-option');
      const retryButton = $('#retry-button');

      function handleModelChoice(event) {
        const choice = event.target.closest('.model-option, #retry-button');
        if (choice) {
          $modelSelection.classList.add('hidden');
          modelOptions.forEach(option => option.removeEventListener('click', handleModelChoice));
          retryButton.removeEventListener('click', handleModelChoice);

          if (choice.textContent.includes('LLaMA 3') || choice === retryButton) {
            selectedModel = 'Llama-3.2-1B-Instruct-q4f32_1-MLC';
            $currentModel.textContent = 'LLaMA 3';
          } else if (choice.textContent.includes('ChatGPT-3.5-turbo')) {
            selectedModel = 'gpt-3.5-turbo';
            $currentModel.textContent = 'ChatGPT-3.5-turbo';
          }

          resolve(selectedModel);
        }
      }

      modelOptions.forEach(option => option.addEventListener('click', handleModelChoice));
      retryButton.addEventListener('click', handleModelChoice);
    });
  }

  // Funci√≥n para cambiar el modelo
  async function changeModel() {
    // Desactivar la entrada de chat mientras se cambia el modelo
    $chatInput.setAttribute('disabled', '');
    $sendMessage.setAttribute('disabled', '');

    selectedModel = await showModelOptions();

    // Reinicializar el engine
    engine = null;
    isEngineInitializing = false;

    // Limpiar los mensajes anteriores
    messages = [];
    $chatMessages.innerHTML = '';

    await addMessage("He cambiado al modelo " + $currentModel.textContent + ". ¬øEn qu√© puedo ayudarte?", 'bot');

    // Reactivar la entrada de chat
    enableChat();
  }

  // Inicializar el engine de forma perezosa
  async function initializeEngine() {
    if (engine && engine.model === selectedModel) return engine;
    if (isEngineInitializing) {
      while (isEngineInitializing) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      return engine;
    }

    isEngineInitializing = true;
    showLoadingIndicator();

    try {
      if (selectedModel === 'Llama-3.2-1B-Instruct-q4f32_1-MLC') {
        engine = await CreateWebWorkerMLCEngine(
          new Worker('/static/js/worker.js', { type: 'module' }),
          selectedModel,
          {
            initProgressCallback: (info) => {
              console.log('Init progress:', info);
              updateLoadingIndicator(info.text);
            }
          }
        );
      } else {
        // Para ChatGPT, no necesitamos inicializar un engine local
        engine = { model: 'gpt-3.5-turbo' };
      }
    } catch (error) {
      console.error('Error initializing engine:', error);
      addMessage("Lo siento, ha ocurrido un error al inicializar el chatbot. Por favor, intenta recargar la p√°gina.", 'bot');
    } finally {
      isEngineInitializing = false;
      hideLoadingIndicator();
    }

    return engine;
  }

  // Funciones para manejar el indicador de carga
  function showLoadingIndicator() {
    const progressText = $('#init-progress-text');
    progressText.textContent = "Cargando el modelo, por favor espera...";
    progressText.classList.remove('hidden');
  }

  function updateLoadingIndicator(text) {
    const progressText = $('#init-progress-text');
    progressText.textContent = text;
  }

  function hideLoadingIndicator() {
    const progressText = $('#init-progress-text');
    progressText.textContent = "Carga completada";
    setTimeout(() => {
      progressText.classList.add('hidden');
    }, 3000);
  }

  // Habilitar el chat cuando el modelo est√© listo
  function enableChat() {
    $chatInput.removeAttribute('disabled');
    $sendMessage.removeAttribute('disabled');
  }

  async function addMessage(text, sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col');

    if (sender === 'user') {
      messageElement.classList.add(
        'bg-blue-700',
        'dark:bg-indigo-700',
        'text-white',
        'ml-auto',
        'inline-block',
        'px-4',
        'py-2',
        'rounded-lg',
        'max-w-[60%]',
        'text-left',
        'font-semibold'
      );
      messageElement.innerHTML = `<p class="text-sm">${text}</p>`;
      $chatMessages.appendChild(messageElement);
    } else {
      messageElement.classList.add(
        'bg-gray-100',
        'dark:bg-[#0f1e41]',
        'mr-auto',
        'px-4',
        'py-2',
        'rounded-lg',
        'w-full',
        'max-w-[80%]',
        'font-semibold'
      );

      const botTextElement = document.createElement('p');
      botTextElement.classList.add('text-sm');
      messageElement.appendChild(botTextElement);

      $chatMessages.appendChild(messageElement);
      $chatMessages.scrollTop = $chatMessages.scrollHeight;

      await typeMessage(botTextElement, text);
    }

    $chatMessages.scrollTop = $chatMessages.scrollHeight;
  }

  // Funci√≥n para animar el texto letra por letra
  function typeMessage(element, text, delay = 50) {
    return new Promise((resolve) => {
      let index = 0;

      function typeNextLetter() {
        if (index < text.length) {
          element.textContent += text.charAt(index);
          index++;
          setTimeout(typeNextLetter, delay);
        } else {
          resolve();
        }
      }

      typeNextLetter();
    });
  }

  // Funci√≥n para llamar a la API de OpenAI (versi√≥n actual)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Comprueba si este cookie comienza con el nombre que buscamos
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function callOpenAIAPI(messages) {
    const csrfToken = getCookie('csrftoken');  // Obt√©n el token CSRF

    const response = await fetch('/core/api/chat/', {
      method: 'POST', // Aseg√∫rate de usar el m√©todo POST
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,  // Incluye el token CSRF aqu√≠
      },
      body: JSON.stringify({
        messages: messages,
      }),
    });

    if (!response.ok) {
      throw new Error('Error al llamar a la API de OpenAI');
    }

    const data = await response.json();
    return data.choices[0].message.content;
  }

  // Enviar el mensaje del usuario
  async function sendMessage() {
    const messageText = $chatInput.value.trim();
    if (messageText === '') return;

    $chatInput.value = '';
    await addMessage(messageText, 'user');
    $chatInput.setAttribute('disabled', '');
    $sendMessage.setAttribute('disabled', '');

    const userMessage = { role: 'user', content: messageText };
    messages.push(userMessage);

    try {
      // Primero, buscar en el JSON
      let reply = findAnswerInJSON(messageText);

      if (reply) {
        // Si se encuentra una respuesta en el JSON, usarla directamente
        await addMessage(reply, 'bot');
      } else {
        // Si no se encuentra en el JSON, usar el modelo seleccionado
        engine = await initializeEngine();

        if (selectedModel === 'Llama-3.2-1B-Instruct-q4f32_1-MLC') {
          const chunks = await engine.chat.completions.create({
            messages,
            stream: true
          });

          reply = '';

          const botMessageElement = document.createElement('div');
          botMessageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col', 'bg-gray-100', 'dark:bg-[#0f1e41]', 'mr-auto', 'px-4', 'py-2', 'rounded-lg', 'w-full', 'max-w-[80%]', 'font-semibold');
          const botTextElement = document.createElement('p');
          botTextElement.classList.add('text-sm');
          botMessageElement.appendChild(botTextElement);
          $chatMessages.appendChild(botMessageElement);
          $chatMessages.scrollTop = $chatMessages.scrollHeight;

          for await (const chunk of chunks) {
            const content = chunk.choices[0]?.delta?.content ?? '';
            reply += content;
            botTextElement.textContent += content;
            $chatMessages.scrollTop = $chatMessages.scrollHeight;
          }
        } else if (selectedModel === 'gpt-3.5-turbo') {
          reply = await callOpenAIAPI(messages);
          await addMessage(reply, 'bot');
        }
      }

      messages.push({ role: 'assistant', content: reply });
    } catch (error) {
      console.error('Error generating response:', error);
      addMessage("Lo siento, ha ocurrido un error al generar la respuesta. Por favor, intenta de nuevo.", 'bot');
    }

    $chatInput.removeAttribute('disabled');
    $sendMessage.removeAttribute('disabled');
    $chatInput.focus();
  }

  // Event Listeners
  if ($openChat && $closeChat) {
    $openChat.addEventListener('click', () => {
      $chatbot.classList.remove('hidden', 'opacity-0', 'translate-y-5');
      $openChat.classList.add('hidden');
      initializeChatbot();
    });

    $closeChat.addEventListener('click', () => {
      $chatbot.classList.add('hidden', 'opacity-0', 'translate-y-5');
      $openChat.classList.remove('hidden');
      $chatMessages.innerHTML = '';
      messages = [];
      selectedModel = null;
      engine = null;
      $currentModel.textContent = 'Ninguno';  // Resetea el modelo mostrado
    });

    $sendMessage.addEventListener('click', sendMessage);
    $chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Nuevo event listener para cambiar el modelo
    $selectedModelDiv.addEventListener('click', changeModel);
  }
</script>

<!-- Script para el sidebar de los temas -->
<script>
  document.addEventListener('DOMContentLoaded', (event) => {
    const sidebar = document.getElementById('drawer-navigation');
    const overlay = document.getElementById('sidebar-overlay');
    const openButton = document.querySelector('[data-drawer-target="drawer-navigation"]');
    const closeButton = document.querySelector('[data-drawer-hide="drawer-navigation"]');

    // Verificar si los elementos existen antes de agregar eventos, para evitar errores si el usuario no est√° logueado
    if (sidebar && openButton && closeButton && overlay) {
      function openSidebar() {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
      }

      function closeSidebar() {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
      }

      openButton.addEventListener('click', openSidebar);
      closeButton.addEventListener('click', closeSidebar);
      overlay.addEventListener('click', closeSidebar);
    }
  });
</script>

<!-- Script para cambiar el idiomas -->
{% load i18n %}
<script>
  function changeLanguage(lang) {
    document.getElementById('selected-language').value = lang;
    document.getElementById('language-form').submit();
  }
  const flagSVG = {
    'en': '<g fill-rule="evenodd"><g stroke-width="1pt"><path fill="#bd3d44" d="M0 0h247v10H0zm0 20h247v10H0zm0 20h247v10H0zm0 20h247v10H0zm0 20h247v10H0zm0 20h247v10H0zm0 20h247v10H0z" transform="scale(3.9385)" /><path fill="#fff" d="M0 10h247v10H0zm0 20h247v10H0zm0 20h247v10H0zm0 20h247v10H0zm0 20h247v10H0zm0 20h247v10H0z" transform="scale(3.9385)" /></g><path fill="#192f5d" d="M0 0h98.8v70H0z" transform="scale(3.9385)" /><path fill="#fff" d="M8.2 3l1 2.8H12L9.7 7.5l.9 2.7-2.4-1.7L6 10.2l.9-2.7-2.4-1.7h3zm16.5 0l.9 2.8h2.9l-2.4 1.7 1 2.7-2.4-1.7-2.4 1.7 1-2.7-2.4-1.7h2.9zm16.5 0l.9 2.8H45l-2.4 1.7 1 2.7-2.4-1.7-2.4 1.7 1-2.7-2.4-1.7h2.9z" transform="scale(3.9385)" /></g>',
    'es': '<path fill="#ffce00" d="M0 128h512v256H0z" /><path fill="#dd0000" d="M0 0h512v128H0zm0 384h512v128H0z" />'
  };
  function updateFlag(lang) {
    const flagSvg = document.getElementById('language-flag');
    flagSvg.innerHTML = flagSVG[lang];
    document.getElementById('language-text').textContent = lang === 'en' ? 'English' : 'Espa√±ol';
  }
  function changeLanguage(lang) {
    document.getElementById('selected-language').value = lang;
    updateFlag(lang);
    document.getElementById('language-form').submit();
  }
  // Inicializar la bandera con el idioma actual
  updateFlag('{{ LANGUAGE_CODE }}');
</script>

<!-- Script de Accesibilidad para cambiar el tama√±o de la letra -->
<script>
    // Variables para el ajuste de tama√±o de fuente
    let currentFontSize = 100;
    const fontSizeStep = 10;
    const minFontSize = 80;
    const maxFontSize = 200;
  
    // Funci√≥n para cambiar el tama√±o de la fuente
    function changeFontSize(action) {
      if (action === 'increase' && currentFontSize < maxFontSize) {
        currentFontSize += fontSizeStep;
      } else if (action === 'decrease' && currentFontSize > minFontSize) {
        currentFontSize -= fontSizeStep;
      }
      document.body.style.fontSize = `${currentFontSize}%`;
    }
  
    // Funci√≥n para resetear el tama√±o de la fuente
    function resetFontSize() {
      currentFontSize = 100;
      document.body.style.fontSize = '100%';
    }
</script>

<!-- Script de Accesibilidad para cambiar el tipo de letra -->
<script>
  // Array de fuentes disponibles, incluyendo la fuente por defecto
  const fonts = ['Quicksand', 'Arial', 'Verdana', 'Georgia', 'Times New Roman', 'Courier New'];
  let currentFontIndex = 0;

  // Funci√≥n para cambiar la tipograf√≠a
  function changeFont() {
      currentFontIndex = (currentFontIndex + 1) % fonts.length;
      const newFont = fonts[currentFontIndex];
      
      // Aplicar la nueva fuente
      document.body.style.fontFamily = newFont;
      
      // Actualizar el texto del bot√≥n para mostrar la fuente actual
      updateFontDisplay(newFont);
      
      // Guardar la fuente seleccionada en localStorage
      localStorage.setItem('selectedFont', newFont);
  }

  // Funci√≥n para actualizar el texto mostrado
  function updateFontDisplay(fontName) {
      const fontDisplay = document.querySelector('.current-font-name');
      if (fontDisplay) {
          fontDisplay.textContent = fontName;
      }
  }

  // Al cargar la p√°gina, aplicar la fuente guardada si existe
  document.addEventListener('DOMContentLoaded', function() {
      const savedFont = localStorage.getItem('selectedFont');
      if (savedFont) {
          document.body.style.fontFamily = savedFont;
          currentFontIndex = fonts.indexOf(savedFont);
          if (currentFontIndex === -1) currentFontIndex = 0;
          
          // Actualizar el texto mostrado con la fuente actual
          updateFontDisplay(savedFont);
      } else {
          // Si no hay fuente guardada, mostrar la fuente por defecto
          updateFontDisplay(fonts[0]);
      }
  });
</script>

 <!-- Script de Accesibilidad para leer la pagina -->
<script>
  function toggleTextToSpeech() {
    // Si hay una lectura en curso, detenerla
    if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        return;
    }

    // Obtener todo el texto visible de la p√°gina
    const text = document.body.innerText;

    // Crear el objeto de voz
    const utterance = new SpeechSynthesisUtterance(text);
    
    // Configurar en espa√±ol
    utterance.lang = 'es-ES';
    
    // Iniciar la lectura
    window.speechSynthesis.speak(utterance);
}
</script>
