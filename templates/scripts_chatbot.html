<!-- Script Chatbot -->
<script type="module">
  import { CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm"

  const $ = el => document.querySelector(el)
  const $openChat = $('#open-chat')
  const $closeChat = $('#close-chat')
  const $chatbot = $('#chatbot')
  const $chatMessages = $('#chat-messages')
  const $chatInput = $('#chat-input')
  const $sendMessage = $('#send-message')
  const $modelSelection = $('#model-selection')
  const $currentModel = $('#current-model')
  const $selectedModelDiv = $('#selected-model')

  let messages = []
  let engine = null
  let jsonData = []
  let isEngineInitializing = false
  let selectedModel = null

  // Nueva función para guardar el modelo seleccionado
  function saveSelectedModel(model) {
    localStorage.setItem('selectedChatbotModel', model);
    localStorage.setItem('selectedChatbotModelName', $currentModel.textContent);
  }

  // Nueva función para recuperar el modelo guardado
  function getSavedModel() {
    const savedModel = localStorage.getItem('selectedChatbotModel');
    const savedModelName = localStorage.getItem('selectedChatbotModelName');
    return { model: savedModel, name: savedModelName };
  }

  // Cargar los datos del JSON
  async function loadJSONData() {
    if (jsonData.length === 0) {
      try {
        const response = await fetch('/static/chatbot_training_data.json');
        jsonData = await response.json();
      } catch (error) {
        console.error('Error loading JSON data:', error);
      }
    }
  }

  // Buscar una respuesta en el JSON
  function findAnswerInJSON(question) {
    const lowerQuestion = question.toLowerCase();
    const match = jsonData.find(item =>
      lowerQuestion.includes(item.question.toLowerCase())
    );
    return match ? match.answer : null;
  }

  // Inicializar el chatbot y cargar el modelo
  async function initializeChatbot() {
    await loadJSONData();

    const $modelSelection = document.querySelector('#model-selection');
    const $currentModel = document.querySelector('#current-model');
  
    if (!$modelSelection || !$currentModel) {
      console.error('Required elements for model selection not found');
      return;
    }
  
    $modelSelection.classList.add('hidden');
  
    // Revisar si hay un modelo guardado
    const savedModel = getSavedModel();
    
    if (savedModel.model) {
      // Si hay un modelo guardado, usarlo
      selectedModel = savedModel.model;
      $currentModel.textContent = savedModel.name || 'LLaMA 3';
    } else {
      // Si no hay modelo guardado, usar un modelo por defecto
      selectedModel = 'Llama-3.2-1B-Instruct-q4f32_1-MLC';
      $currentModel.textContent = 'LLaMA 3';
      saveSelectedModel(selectedModel);
    }
  
    // Resetea el modelo mostrado
    $currentModel.textContent = 'Ninguno';
  
    selectedModel = await showModelOptions();
    
    // Opciones principales del menú
    const mainMenuOptions = [
      "¿Quién eres?",
      "Información sobre autenticación",
      "Información sobre el sistema",
      "Perfil del Usuario",
      "Información sobre alertas",
      "Información sobre monitoreo",
      "Información sobre reportes"
    ];
  
    // Mensaje de bienvenida personalizado con emojis relevantes
    const welcomeMessage = [
      "¡Hola 👋! Soy Alexis, tu ChatBot personal.",
      "Estoy aquí para ayudarte con cualquier duda al momento de usar nuestro software.",
      "¿En qué puedo ayudarte 😊?"
    ].join("\n");
  
    await addMessageWithOptions(
      welcomeMessage,
      mainMenuOptions,
      'bot'
    );
  
    // Pequeña pausa para mejor experiencia de usuario
    await new Promise(resolve => setTimeout(resolve, 1000));
  
  
    enableChat();
  }

  // Nueva función para crear una opción seleccionable
  function createOption(text) {
    const option = document.createElement('div');
    option.className = 'text-center text-sm text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 my-2 py-2 rounded-lg mx-4 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200';
    option.innerHTML = `<span>${text}</span>`;
    
    option.addEventListener('click', async () => {
      // Agregar la selección como mensaje del usuario
      await addMessage(text, 'user');
      
      // Procesar la respuesta basada en la opción seleccionada
      handleOptionSelection(text);
    });
    
    return option;
  }

  // Nueva función para agregar mensaje con opciones
  async function addMessageWithOptions(text, options = [], sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col');

    if (sender === 'bot') {
      messageElement.classList.add(
        'bg-gray-100',
        'dark:bg-[#0f1e41]',
        'mr-auto',
        'px-4',
        'py-2',
        'rounded-lg',
        'w-full',
        'max-w-[80%]',
        'font-semibold'
      );

      const botTextElement = document.createElement('p');
      botTextElement.classList.add('text-sm');
      messageElement.appendChild(botTextElement);

      $chatMessages.appendChild(messageElement);
      await typeMessage(botTextElement, text);

      // Agregar opciones después del mensaje
      if (options.length > 0) {
        const optionsContainer = document.createElement('div');
        optionsContainer.classList.add('mt-4');
        options.forEach(optionText => {
          optionsContainer.appendChild(createOption(optionText));
        });
        $chatMessages.appendChild(optionsContainer);
      }
    } else {
      messageElement.classList.add(
        'bg-blue-700',
        'dark:bg-indigo-700',
        'text-white',
        'ml-auto',
        'inline-block',
        'px-4',
        'py-2',
        'rounded-lg',
        'max-w-[60%]',
        'text-left',
        'font-semibold'
      );
      messageElement.innerHTML = `<p class="text-sm">${text}</p>`;
      $chatMessages.appendChild(messageElement);
    }

    $chatMessages.scrollTop = $chatMessages.scrollHeight;
  }

  // Nueva función para manejar la selección de opciones
  async function handleOptionSelection(option) {
    let response;
    let nextOptions = [];
  
    switch (option) {
      // Menú Principal
      case "Volver al menú principal":
        response = "¿En qué más puedo ayudarte?";
        nextOptions = [
          "¿Quién eres?",
          "Información sobre autenticación",
          "Información sobre el sistema",
          "Perfil del Usuario",
          "Información sobre alertas",
          "Información sobre monitoreo",
          "Información sobre reportes"
        ];
        break;
      // Perfil del Usuario (Nueva sección)
      case "Perfil del Usuario":
        response = "¿Qué te gustaría saber sobre tu perfil de usuario?";
        nextOptions = [
          "Información personal",
          "Preferencias del sistema",
          "Permisos y roles",
          "Volver al menú principal"
        ];
        break;

      case "Información personal":
        response = "¿Qué información personal necesitas gestionar?";
        nextOptions = [
          "¿Cómo actualizo mis datos personales?",
          "¿Puedo cambiar mi correo electrónico?",
          "Volver al menú principal"
        ];
        break;

      case "Preferencias del sistema":
        response = "¿Qué preferencias del sistema te gustaría configurar?";
        nextOptions = [
          "¿Cómo cambio el tema de la interfaz?",
          "Volver al menú principal"
        ];
        break;

      case "Permisos y roles":
        response = "¿Qué necesitas saber sobre tus permisos y roles?";
        nextOptions = [
          "¿Qué permisos tengo actualmente?",
          "¿Cómo solicito permisos adicionales?",
          "¿Cuáles son los diferentes roles disponibles?",
          "Volver al menú principal"
        ];
      break;
      // Autenticación
      case "Información sobre autenticación":
        response = "Tenemos varias opciones de autenticación. ¿Qué te gustaría conocer?";
        nextOptions = [
          "Métodos de autenticación disponibles",
          "Gestión de contraseña",
          "Configuración de perfil",
          "Volver al menú principal"
        ];
        break;
  
      case "Métodos de autenticación disponibles":
        response = "El sistema ofrece registro y login tradicionales, reconocimiento facial, y gestión de contraseñas.";
        nextOptions = [
          "¿Tengo que usar contraseña siempre?",
          "¿Cómo funciona el reconocimiento facial?",
          "Volver al menú principal"
        ];
        break;
  
      case "Gestión de contraseña":
        response = "¿Qué necesitas saber sobre la gestión de tu contraseña?";
        nextOptions = [
          "¿Cómo cambio mi contraseña?",
          "¿Qué pasa si me roban el celular? ¿Pueden entrar a mi cuenta?",
          "Volver al menú principal"
        ];
        break;
  
      case "Configuración de perfil":
        response = "¿Qué te gustaría configurar en tu perfil?";
        nextOptions = [
          "¿Qué opciones tienen los usuarios en su perfil?",
          "Oye, ¿y si quiero cambiar mi foto de perfil?",
          "Volver al menú principal"
        ];
        break;
  
      // Sistema
      case "Información sobre el sistema":
        response = "¿Qué aspecto del sistema te gustaría conocer?";
        nextOptions = [
          "Rendimiento y acceso",
          "Configuración general",
          "Volver al menú principal"
        ];
        break;
  
      case "Rendimiento y acceso":
        response = "¿Qué información necesitas sobre el rendimiento y acceso?";
        nextOptions = [
          "¿Qué tan rápido funciona todo esto?",
          "¿Puedo usar esto desde mi celular?",
          "Todo esto suena genial, pero ¿qué pasa si se va la luz?",
          "Volver al menú principal"
        ];
        break;
  
      case "Configuración general":
        response = "¿Qué necesitas saber sobre la configuración?";
        nextOptions = [
          "¿Qué tan difícil es configurar todo esto?",
          "¿Esto funciona solo para empresas grandes?",
          "¿Qué pasa con las actualizaciones? ¿Tengo que hacer algo?",
          "Volver al menú principal"
        ];
        break;
  
      // Alertas
      case "Información sobre alertas":
        response = "¿Qué te gustaría saber sobre nuestro sistema de alertas?";
        nextOptions = [
          "Tipos de amenazas",
          "Configuración de alertas",
          "Volver al menú principal"
        ];
        break;
  
      case "Tipos de amenazas":
        response = "¿Qué información necesitas sobre las amenazas?";
        nextOptions = [
          "¿Cómo detecta el sistema comportamientos sospechosos?",
          "Eso de las amenazas suena intenso. ¿Qué tipo de cosas detecta el sistema?",
          "Me da cosa eso de las amenazas. ¿Cómo sé si está pasando algo raro?",
          "Volver al menú principal"
        ];
        break;
  
      case "Configuración de alertas":
        response = "¿Qué necesitas saber sobre la configuración de alertas?";
        nextOptions = [
          "¿Cómo configuro una alerta personalizada?",
          "¿Qué tipos de alertas ofrece el sistema?",
          "¿Y si quiero que me avise de algo específico?",
          "Volver al menú principal"
        ];
        break;
  
      // Monitoreo
      case "Información sobre monitoreo":
        response = "¿Qué te gustaría saber sobre el monitoreo?";
        nextOptions = [
          "¿Cómo creo una nueva sesión de monitoreo?",
          "¿Puedo ver lo que está pasando en tiempo real?",
          "¿Y si pasa algo cuando no estoy mirando?",
          "Volver al menú principal"
        ];
        break;
  
      // Reportes
      case "Información sobre reportes":
        response = "¿Qué información necesitas sobre los reportes?";
        nextOptions = [
          "Me interesa eso de las estadísticas. ¿Qué tipo de info puedo ver?",
          "¿Puedo compartir los reportes con mi equipo?",
          "Esto de la privacidad... ¿mis datos están seguros?",
          "Volver al menú principal"
        ];
        break;
  
      // Identificación
      case "¿Quién eres?":
        response = "Hola, soy Alexis, el asistente personal de la empresa PASYS ALERTE, mi misión es responder cualquier duda que tengas al momento de usar nuestro Software 😊.";
        nextOptions = [
          "¿Y si necesito ayuda con algo?",
          "Volver al menú principal"
        ];
        break;
  
      default:
        // Buscar en el JSON de respuestas
        const jsonResponse = findAnswerInJSON(option);
        if (jsonResponse) {
          response = jsonResponse;
        } else {
          response = "¿Hay algo más en lo que pueda ayudarte?";
        }
        nextOptions = ["Volver al menú principal"];
    }
  
    // Esperar un momento antes de mostrar la respuesta
    await new Promise(resolve => setTimeout(resolve, 500));
    await addMessageWithOptions(response, nextOptions, 'bot');
  }

  // Función para mostrar opciones de modelo
  function showModelOptions() {
    return new Promise((resolve) => {
      const $modelSelection = document.querySelector('#model-selection');
      const $currentModel = document.querySelector('#current-model');
      
      if (!$modelSelection) {
        console.error('Model selection element not found');
        resolve('Llama-3.2-1B-Instruct-q4f32_1-MLC'); // Default model
        return;
      }
  
      $modelSelection.classList.remove('hidden');
  
      const modelOptions = $modelSelection.querySelectorAll('.model-option');
      const retryButton = $modelSelection.querySelector('#retry-button');
  
      if (!retryButton || modelOptions.length === 0) {
        console.error('Model options or retry button not found');
        resolve('Llama-3.2-1B-Instruct-q4f32_1-MLC'); // Default model
        return;
      }
  
      function handleModelChoice(event) {
        const choice = event.target.closest('.model-option, #retry-button');
        if (choice) {
          $modelSelection.classList.add('hidden');
          modelOptions.forEach(option => option.removeEventListener('click', handleModelChoice));
          retryButton.removeEventListener('click', handleModelChoice);
  
          if (choice.textContent.includes('LLaMA 3') || choice === retryButton) {
            selectedModel = 'Llama-3.2-1B-Instruct-q4f32_1-MLC';
            $currentModel.textContent = 'LLaMA 3';
          } else if (choice.textContent.includes('ChatGPT-3.5-turbo')) {
            selectedModel = 'gpt-3.5-turbo';
            $currentModel.textContent = 'ChatGPT-3.5-turbo';
          }
  
          resolve(selectedModel);
        }
      }
  
      modelOptions.forEach(option => option.addEventListener('click', handleModelChoice));
      retryButton.addEventListener('click', handleModelChoice);
    });
  }

  // Función para cambiar el modelo
  async function changeModel() {
    await loadJSONData();

    $modelSelection.classList.add('hidden');

    // Desactivar la entrada de chat mientras se cambia el modelo
    $chatInput.setAttribute('disabled', '');
    $sendMessage.setAttribute('disabled', '');

    // Opciones principales del menú
    const mainMenuOptions = [
      "¿Quién eres?",
      "Información sobre autenticación", 
      "Información sobre el sistema",
      "Perfil del Usuario",
      "Información sobre alertas",
      "Información sobre monitoreo",
      "Información sobre reportes"
    ];

    selectedModel = await showModelOptions();
    saveSelectedModel(selectedModel);

    // Mensaje de cambio de modelo con las opciones del menú
    const changeModelMessage = "He cambiado al modelo " + $currentModel.textContent + ". ¿En qué puedo ayudarte?";
    
    await addMessageWithOptions(
      changeModelMessage,
      mainMenuOptions,
      'bot'
    );

    // Reactivar la entrada de chat
    enableChat();
  }

  // Inicializar el engine de forma perezosa
  async function initializeEngine() {
    if (engine && engine.model === selectedModel) return engine;
    if (isEngineInitializing) {
      while (isEngineInitializing) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      return engine;
    }

    isEngineInitializing = true;
    showLoadingIndicator();

    try {
      if (selectedModel === 'Llama-3.2-1B-Instruct-q4f32_1-MLC') {
        engine = await CreateWebWorkerMLCEngine(
          new Worker('/static/js/worker.js', { type: 'module' }),
          selectedModel,
          {
            initProgressCallback: (info) => {
              console.log('Init progress:', info);
              updateLoadingIndicator(info.text);
            }
          }
        );
      } else {
        // Para ChatGPT, no necesitamos inicializar un engine local
        engine = { model: 'gpt-3.5-turbo' };
      }
    } catch (error) {
      console.error('Error initializing engine:', error);
      addMessage("Lo siento, ha ocurrido un error al inicializar el chatbot. Por favor, intenta recargar la página.", 'bot');
    } finally {
      isEngineInitializing = false;
      hideLoadingIndicator();
    }

    return engine;
  }

  // Funciones para manejar el indicador de carga
  function showLoadingIndicator() {
    const progressText = $('#init-progress-text');
    progressText.textContent = "Cargando el modelo, por favor espera...";
    progressText.classList.remove('hidden');
  }

  function updateLoadingIndicator(text) {
    const progressText = $('#init-progress-text');
    progressText.textContent = text;
  }

  function hideLoadingIndicator() {
    const progressText = $('#init-progress-text');
    progressText.textContent = "Carga completada";
    setTimeout(() => {
      progressText.classList.add('hidden');
    }, 3000);
  }

  // Habilitar el chat cuando el modelo esté listo
  function enableChat() {
    $chatInput.removeAttribute('disabled');
    $sendMessage.removeAttribute('disabled');
  }

  async function addMessage(text, sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col');

    if (sender === 'user') {
      messageElement.classList.add(
        'bg-blue-700',
        'dark:bg-indigo-700',
        'text-white',
        'ml-auto',
        'inline-block',
        'px-4',
        'py-2',
        'rounded-lg',
        'max-w-[60%]',
        'text-left',
        'font-semibold'
      );
      messageElement.innerHTML = `<p class="text-sm">${text}</p>`;
      $chatMessages.appendChild(messageElement);
    } else {
      messageElement.classList.add(
        'bg-gray-100',
        'dark:bg-[#0f1e41]',
        'mr-auto',
        'px-4',
        'py-2',
        'rounded-lg',
        'w-full',
        'max-w-[80%]',
        'font-semibold'
      );

      const botTextElement = document.createElement('p');
      botTextElement.classList.add('text-sm');
      messageElement.appendChild(botTextElement);

      $chatMessages.appendChild(messageElement);
      $chatMessages.scrollTop = $chatMessages.scrollHeight;

      await typeMessage(botTextElement, text);
    }

    $chatMessages.scrollTop = $chatMessages.scrollHeight;
  }

  // Función para animar el texto letra por letra
  function typeMessage(element, text, delay = 50) {
    return new Promise((resolve) => {
      let index = 0;

      function typeNextLetter() {
        if (index < text.length) {
          element.textContent += text.charAt(index);
          index++;
          setTimeout(typeNextLetter, delay);
        } else {
          resolve();
        }
      }

      typeNextLetter();
    });
  }

  // Función para llamar a la API de OpenAI (versión actual)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Comprueba si este cookie comienza con el nombre que buscamos
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function callOpenAIAPI(messages) {
    const csrfToken = getCookie('csrftoken');  // Obtén el token CSRF

    const response = await fetch('/core/api/chat/', {
      method: 'POST', // Asegúrate de usar el método POST
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,  // Incluye el token CSRF aquí
      },
      body: JSON.stringify({
        messages: messages,
      }),
    });

    if (!response.ok) {
      throw new Error('Error al llamar a la API de OpenAI');
    }

    const data = await response.json();
    return data.choices[0].message.content;
  }

  // Enviar el mensaje del usuario
  async function sendMessage() {
    const messageText = $chatInput.value.trim();
    if (messageText === '') return;

    $chatInput.value = '';
    await addMessage(messageText, 'user');
    $chatInput.setAttribute('disabled', '');
    $sendMessage.setAttribute('disabled', '');

    const userMessage = { role: 'user', content: messageText };
    messages.push(userMessage);

    try {
      // Primero, buscar en el JSON
      let reply = findAnswerInJSON(messageText);

      if (reply) {
        // Si se encuentra una respuesta en el JSON, usarla directamente
        await addMessage(reply, 'bot');
      } else {
        // Si no se encuentra en el JSON, usar el modelo seleccionado
        engine = await initializeEngine();

        if (selectedModel === 'Llama-3.2-1B-Instruct-q4f32_1-MLC') {
          const chunks = await engine.chat.completions.create({
            messages,
            stream: true
          });

          reply = '';

          const botMessageElement = document.createElement('div');
          botMessageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col', 'bg-gray-100', 'dark:bg-[#0f1e41]', 'mr-auto', 'px-4', 'py-2', 'rounded-lg', 'w-full', 'max-w-[80%]', 'font-semibold');
          const botTextElement = document.createElement('p');
          botTextElement.classList.add('text-sm');
          botMessageElement.appendChild(botTextElement);
          $chatMessages.appendChild(botMessageElement);
          $chatMessages.scrollTop = $chatMessages.scrollHeight;

          for await (const chunk of chunks) {
            const content = chunk.choices[0]?.delta?.content ?? '';
            reply += content;
            botTextElement.textContent += content;
            $chatMessages.scrollTop = $chatMessages.scrollHeight;
          }
        } else if (selectedModel === 'gpt-3.5-turbo') {
          reply = await callOpenAIAPI(messages);
          await addMessage(reply, 'bot');
        }
      }

      messages.push({ role: 'assistant', content: reply });
    } catch (error) {
      console.error('Error generating response:', error);
      addMessage("Lo siento, ha ocurrido un error al generar la respuesta. Por favor, intenta de nuevo.", 'bot');
    }

    $chatInput.removeAttribute('disabled');
    $sendMessage.removeAttribute('disabled');
    $chatInput.focus();
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    const $openChat = document.querySelector('#open-chat');
    const $closeChat = document.querySelector('#close-chat');
    const $chatbot = document.querySelector('#chatbot');
    const $chatMessages = document.querySelector('#chat-messages');
    const $chatInput = document.querySelector('#chat-input');
    const $sendMessage = document.querySelector('#send-message');
    const $selectedModelDiv = document.querySelector('#selected-model');

    if ($openChat && $closeChat && $chatbot && $chatMessages && $chatInput && $sendMessage && $selectedModelDiv) {
      $openChat.addEventListener('click', () => {
        $chatbot.classList.remove('hidden', 'opacity-0', 'translate-y-5');
        $openChat.classList.add('hidden');
        initializeChatbot();
      });

      $closeChat.addEventListener('click', () => {
        $chatbot.classList.add('hidden', 'opacity-0', 'translate-y-5');
        $openChat.classList.remove('hidden');
        $chatMessages.innerHTML = '';
        messages = [];
        engine = null;
      });

      $sendMessage.addEventListener('click', sendMessage);
      $chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });

      // Nuevo event listener para cambiar el modelo
      $selectedModelDiv.addEventListener('click', changeModel);
    } else {
      console.error('Some required chat elements are missing');
    }
  });
</script>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const openChatBtn = document.getElementById('open-chat');
    const closeChatBtn = document.getElementById('close-chat');
    const chatbot = document.getElementById('chatbot');
    const chatInput = document.getElementById('chat-input');
    const sendMessageBtn = document.getElementById('send-message');
    const voiceInputBtn = document.getElementById('voice-input');
    const recordingIndicator = document.getElementById('recording-indicator');
  
    // Variables para el reconocimiento de voz
    let recognition = null;
    let isRecording = false;
  
    // Inicializar el reconocimiento de voz
    function initializeSpeechRecognition() {
      if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'es-ES'; // Configura el idioma según necesites
  
        // Configurar eventos del reconocimiento de voz
        recognition.onstart = function() {
          isRecording = true;
          voiceInputBtn.innerHTML = '<i class="fas fa-stop text-red-500"></i>';
          recordingIndicator.classList.remove('hidden');
          chatInput.placeholder = 'Escuchando...';
        };
  
        recognition.onend = function() {
          isRecording = false;
          voiceInputBtn.innerHTML = '<i class="fas fa-microphone"></i>';
          recordingIndicator.classList.add('hidden');
          chatInput.placeholder = 'Escribe tu mensaje...';
        };
  
        recognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          chatInput.value = transcript;
          // Habilitar el botón de enviar si hay texto
          sendMessageBtn.disabled = !chatInput.value.trim();
        };
  
        recognition.onerror = function(event) {
          console.error('Error en el reconocimiento de voz:', event.error);
          stopRecording();
          // Mostrar mensaje de error al usuario
          showErrorToast('Error en el reconocimiento de voz. Por favor, intenta de nuevo.');
        };
      } else {
        voiceInputBtn.style.display = 'none';
        showErrorToast('Tu navegador no soporta el reconocimiento de voz.');
      }
    }
  
    // Función para mostrar mensajes de error
    function showErrorToast(message) {
      // Implementa tu propio sistema de notificaciones aquí
      console.error(message);
    }
  
    // Función para iniciar/detener la grabación
    function toggleRecording() {
      if (!recognition) {
        initializeSpeechRecognition();
      }
  
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    }
  
    function startRecording() {
      try {
        recognition.start();
      } catch (error) {
        console.error('Error al iniciar la grabación:', error);
      }
    }
  
    function stopRecording() {
      try {
        recognition.stop();
      } catch (error) {
        console.error('Error al detener la grabación:', error);
      }
    }
  
    // Event Listeners
    voiceInputBtn.addEventListener('click', toggleRecording);
  
    // Funcionalidad del chat
    openChatBtn.addEventListener('click', () => {
      chatbot.classList.remove('hidden');
      setTimeout(() => {
        chatbot.classList.remove('opacity-0', 'translate-y-5');
      }, 50);
    });
  
    closeChatBtn.addEventListener('click', () => {
      chatbot.classList.add('opacity-0', 'translate-y-5');
      setTimeout(() => {
        chatbot.classList.add('hidden');
      }, 300);
      // Detener la grabación si está activa
      if (isRecording) {
        stopRecording();
      }
    });
  
    // Habilitar/deshabilitar botón de enviar según el contenido del input
    chatInput.addEventListener('input', function() {
      sendMessageBtn.disabled = !this.value.trim();
    });
  
    // Manejar el envío de mensajes
    function handleSendMessage() {
      const message = chatInput.value.trim();
      if (message) {
        // Aquí va tu lógica para enviar el mensaje
        console.log('Mensaje enviado:', message);
        chatInput.value = '';
        sendMessageBtn.disabled = true;
      }
    }
  
    sendMessageBtn.addEventListener('click', handleSendMessage);
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSendMessage();
      }
    });
  
    // Inicializar el reconocimiento de voz al cargar
    initializeSpeechRecognition();
  });
  </script>

  <!-- Script para la funcionalidad del selector de emojis -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const emojiButton = document.getElementById('emoji-button');
    const emojiPicker = document.getElementById('emoji-picker');
    const closeEmoji = document.getElementById('close-emoji');
    const chatInput = document.getElementById('chat-input');
    
    // Mostrar/ocultar el selector de emojis
    emojiButton.addEventListener('click', () => {
      emojiPicker.classList.toggle('hidden');
    });
    
    // Cerrar el selector de emojis
    closeEmoji.addEventListener('click', () => {
      emojiPicker.classList.add('hidden');
    });
    
    // Añadir emoji al input cuando se selecciona
    const emojiButtons = emojiPicker.querySelectorAll('.grid button');
    emojiButtons.forEach(button => {
      button.addEventListener('click', () => {
        const emoji = button.textContent;
        const cursorPos = chatInput.selectionStart;
        const textBefore = chatInput.value.substring(0, cursorPos);
        const textAfter = chatInput.value.substring(cursorPos);
        chatInput.value = textBefore + emoji + textAfter;
        chatInput.focus();
        // Mover el cursor después del emoji insertado
        const newCursorPos = cursorPos + emoji.length;
        chatInput.setSelectionRange(newCursorPos, newCursorPos);
      });
    });
    
    // Cerrar el selector de emojis al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!emojiPicker.contains(e.target) && !emojiButton.contains(e.target)) {
        emojiPicker.classList.add('hidden');
      }
    });
  });
  </script>