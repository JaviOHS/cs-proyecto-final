<!-- Script Chatbot -->
<script type="module">
  import { CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm"

  const $ = el => document.querySelector(el)
  const $openChat = $('#open-chat')
  const $closeChat = $('#close-chat')
  const $chatbot = $('#chatbot')
  const $chatMessages = $('#chat-messages')
  const $chatInput = $('#chat-input')
  const $sendMessage = $('#send-message')
  const $modelSelection = $('#model-selection')
  const $currentModel = $('#current-model')
  const $selectedModelDiv = $('#selected-model')

  let messages = []
  let engine = null
  let jsonData = []
  let isEngineInitializing = false
  let selectedModel = null

  // Cargar los datos del JSON
  async function loadJSONData() {
    if (jsonData.length === 0) {
      try {
        const response = await fetch('/static/chatbot_training_data.json');
        jsonData = await response.json();
      } catch (error) {
        console.error('Error loading JSON data:', error);
      }
    }
  }

  // Buscar una respuesta en el JSON
  function findAnswerInJSON(question) {
    const lowerQuestion = question.toLowerCase();
    const match = jsonData.find(item =>
      lowerQuestion.includes(item.question.toLowerCase())
    );
    return match ? match.answer : null;
  }

  // Inicializar el chatbot y cargar el modelo
  async function initializeChatbot() {
    await loadJSONData();
  
    $modelSelection.classList.add('hidden');
  
    // Resetea el modelo mostrado
    $currentModel.textContent = 'Ninguno';
  
    selectedModel = await showModelOptions();
    
    // Opciones principales del men√∫
    const mainMenuOptions = [
      "¬øQui√©n eres?",
      "Informaci√≥n sobre autenticaci√≥n",
      "Informaci√≥n sobre el sistema",
      "Perfil del Usuario",
      "Informaci√≥n sobre alertas",
      "Informaci√≥n sobre monitoreo",
      "Informaci√≥n sobre reportes"
    ];
  
    // Mensaje de bienvenida personalizado con emojis relevantes
    const welcomeMessage = [
      "¬°Hola üëã! Soy Alexis, tu ChatBot personal.",
      "Estoy aqu√≠ para ayudarte con cualquier duda al momento de usar nuestro software.",
      "¬øEn qu√© puedo ayudarte üòä?"
    ].join("\n");
  
    await addMessageWithOptions(
      welcomeMessage,
      mainMenuOptions,
      'bot'
    );
  
    // Peque√±a pausa para mejor experiencia de usuario
    await new Promise(resolve => setTimeout(resolve, 1000));
  
  
    enableChat();
  }

  // Nueva funci√≥n para crear una opci√≥n seleccionable
  function createOption(text) {
    const option = document.createElement('div');
    option.className = 'text-center text-sm text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 my-2 py-2 rounded-lg mx-4 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200';
    option.innerHTML = `<span>${text}</span>`;
    
    option.addEventListener('click', async () => {
      // Agregar la selecci√≥n como mensaje del usuario
      await addMessage(text, 'user');
      
      // Procesar la respuesta basada en la opci√≥n seleccionada
      handleOptionSelection(text);
    });
    
    return option;
  }

  // Nueva funci√≥n para agregar mensaje con opciones
  async function addMessageWithOptions(text, options = [], sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col');

    if (sender === 'bot') {
      messageElement.classList.add(
        'bg-gray-100',
        'dark:bg-[#0f1e41]',
        'mr-auto',
        'px-4',
        'py-2',
        'rounded-lg',
        'w-full',
        'max-w-[80%]',
        'font-semibold'
      );

      const botTextElement = document.createElement('p');
      botTextElement.classList.add('text-sm');
      messageElement.appendChild(botTextElement);

      $chatMessages.appendChild(messageElement);
      await typeMessage(botTextElement, text);

      // Agregar opciones despu√©s del mensaje
      if (options.length > 0) {
        const optionsContainer = document.createElement('div');
        optionsContainer.classList.add('mt-4');
        options.forEach(optionText => {
          optionsContainer.appendChild(createOption(optionText));
        });
        $chatMessages.appendChild(optionsContainer);
      }
    } else {
      messageElement.classList.add(
        'bg-blue-700',
        'dark:bg-indigo-700',
        'text-white',
        'ml-auto',
        'inline-block',
        'px-4',
        'py-2',
        'rounded-lg',
        'max-w-[60%]',
        'text-left',
        'font-semibold'
      );
      messageElement.innerHTML = `<p class="text-sm">${text}</p>`;
      $chatMessages.appendChild(messageElement);
    }

    $chatMessages.scrollTop = $chatMessages.scrollHeight;
  }

  // Nueva funci√≥n para manejar la selecci√≥n de opciones
  async function handleOptionSelection(option) {
    let response;
    let nextOptions = [];
  
    switch (option) {
      // Men√∫ Principal
      case "Volver al men√∫ principal":
        response = "¬øEn qu√© m√°s puedo ayudarte?";
        nextOptions = [
          "¬øQui√©n eres?",
          "Informaci√≥n sobre autenticaci√≥n",
          "Informaci√≥n sobre el sistema",
          "Perfil del Usuario",
          "Informaci√≥n sobre alertas",
          "Informaci√≥n sobre monitoreo",
          "Informaci√≥n sobre reportes"
        ];
        break;
      // Perfil del Usuario (Nueva secci√≥n)
      case "Perfil del Usuario":
        response = "¬øQu√© te gustar√≠a saber sobre tu perfil de usuario?";
        nextOptions = [
          "Informaci√≥n personal",
          "Preferencias del sistema",
          "Permisos y roles",
          "Volver al men√∫ principal"
        ];
        break;

      case "Informaci√≥n personal":
        response = "¬øQu√© informaci√≥n personal necesitas gestionar?";
        nextOptions = [
          "¬øC√≥mo actualizo mis datos personales?",
          "¬øPuedo cambiar mi correo electr√≥nico?",
          "Volver al men√∫ principal"
        ];
        break;

      case "Preferencias del sistema":
        response = "¬øQu√© preferencias del sistema te gustar√≠a configurar?";
        nextOptions = [
          "¬øC√≥mo cambio el tema de la interfaz?",
          "Volver al men√∫ principal"
        ];
        break;

      case "Permisos y roles":
        response = "¬øQu√© necesitas saber sobre tus permisos y roles?";
        nextOptions = [
          "¬øQu√© permisos tengo actualmente?",
          "¬øC√≥mo solicito permisos adicionales?",
          "¬øCu√°les son los diferentes roles disponibles?",
          "Volver al men√∫ principal"
        ];
      break;
      // Autenticaci√≥n
      case "Informaci√≥n sobre autenticaci√≥n":
        response = "Tenemos varias opciones de autenticaci√≥n. ¬øQu√© te gustar√≠a conocer?";
        nextOptions = [
          "M√©todos de autenticaci√≥n disponibles",
          "Gesti√≥n de contrase√±a",
          "Configuraci√≥n de perfil",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "M√©todos de autenticaci√≥n disponibles":
        response = "El sistema ofrece registro y login tradicionales, reconocimiento facial, y gesti√≥n de contrase√±as.";
        nextOptions = [
          "¬øTengo que usar contrase√±a siempre?",
          "¬øC√≥mo funciona el reconocimiento facial?",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Gesti√≥n de contrase√±a":
        response = "¬øQu√© necesitas saber sobre la gesti√≥n de tu contrase√±a?";
        nextOptions = [
          "¬øC√≥mo cambio mi contrase√±a?",
          "¬øQu√© pasa si me roban el celular? ¬øPueden entrar a mi cuenta?",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Configuraci√≥n de perfil":
        response = "¬øQu√© te gustar√≠a configurar en tu perfil?";
        nextOptions = [
          "¬øQu√© opciones tienen los usuarios en su perfil?",
          "Oye, ¬øy si quiero cambiar mi foto de perfil?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Sistema
      case "Informaci√≥n sobre el sistema":
        response = "¬øQu√© aspecto del sistema te gustar√≠a conocer?";
        nextOptions = [
          "Rendimiento y acceso",
          "Configuraci√≥n general",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Rendimiento y acceso":
        response = "¬øQu√© informaci√≥n necesitas sobre el rendimiento y acceso?";
        nextOptions = [
          "¬øQu√© tan r√°pido funciona todo esto?",
          "¬øPuedo usar esto desde mi celular?",
          "Todo esto suena genial, pero ¬øqu√© pasa si se va la luz?",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Configuraci√≥n general":
        response = "¬øQu√© necesitas saber sobre la configuraci√≥n?";
        nextOptions = [
          "¬øQu√© tan dif√≠cil es configurar todo esto?",
          "¬øEsto funciona solo para empresas grandes?",
          "¬øQu√© pasa con las actualizaciones? ¬øTengo que hacer algo?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Alertas
      case "Informaci√≥n sobre alertas":
        response = "¬øQu√© te gustar√≠a saber sobre nuestro sistema de alertas?";
        nextOptions = [
          "Tipos de amenazas",
          "Configuraci√≥n de alertas",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Tipos de amenazas":
        response = "¬øQu√© informaci√≥n necesitas sobre las amenazas?";
        nextOptions = [
          "¬øC√≥mo detecta el sistema comportamientos sospechosos?",
          "Eso de las amenazas suena intenso. ¬øQu√© tipo de cosas detecta el sistema?",
          "Me da cosa eso de las amenazas. ¬øC√≥mo s√© si est√° pasando algo raro?",
          "Volver al men√∫ principal"
        ];
        break;
  
      case "Configuraci√≥n de alertas":
        response = "¬øQu√© necesitas saber sobre la configuraci√≥n de alertas?";
        nextOptions = [
          "¬øC√≥mo configuro una alerta personalizada?",
          "¬øQu√© tipos de alertas ofrece el sistema?",
          "¬øY si quiero que me avise de algo espec√≠fico?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Monitoreo
      case "Informaci√≥n sobre monitoreo":
        response = "¬øQu√© te gustar√≠a saber sobre el monitoreo?";
        nextOptions = [
          "¬øC√≥mo creo una nueva sesi√≥n de monitoreo?",
          "¬øPuedo ver lo que est√° pasando en tiempo real?",
          "¬øY si pasa algo cuando no estoy mirando?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Reportes
      case "Informaci√≥n sobre reportes":
        response = "¬øQu√© informaci√≥n necesitas sobre los reportes?";
        nextOptions = [
          "Me interesa eso de las estad√≠sticas. ¬øQu√© tipo de info puedo ver?",
          "¬øPuedo compartir los reportes con mi equipo?",
          "Esto de la privacidad... ¬ømis datos est√°n seguros?",
          "Volver al men√∫ principal"
        ];
        break;
  
      // Identificaci√≥n
      case "¬øQui√©n eres?":
        response = "Hola, soy Alexis, el asistente personal de la empresa PASYS ALERTE, mi misi√≥n es responder cualquier duda que tengas al momento de usar nuestro Software üòä.";
        nextOptions = [
          "¬øY si necesito ayuda con algo?",
          "Volver al men√∫ principal"
        ];
        break;
  
      default:
        // Buscar en el JSON de respuestas
        const jsonResponse = findAnswerInJSON(option);
        if (jsonResponse) {
          response = jsonResponse;
        } else {
          response = "¬øHay algo m√°s en lo que pueda ayudarte?";
        }
        nextOptions = ["Volver al men√∫ principal"];
    }
  
    // Esperar un momento antes de mostrar la respuesta
    await new Promise(resolve => setTimeout(resolve, 500));
    await addMessageWithOptions(response, nextOptions, 'bot');
  }

  // Funci√≥n para mostrar opciones de modelo
  function showModelOptions() {
    return new Promise((resolve) => {
      $modelSelection.classList.remove('hidden');

      const modelOptions = $modelSelection.querySelectorAll('.model-option');
      const retryButton = $('#retry-button');

      function handleModelChoice(event) {
        const choice = event.target.closest('.model-option, #retry-button');
        if (choice) {
          $modelSelection.classList.add('hidden');
          modelOptions.forEach(option => option.removeEventListener('click', handleModelChoice));
          retryButton.removeEventListener('click', handleModelChoice);

          if (choice.textContent.includes('LLaMA 3') || choice === retryButton) {
            selectedModel = 'Llama-3.2-1B-Instruct-q4f32_1-MLC';
            $currentModel.textContent = 'LLaMA 3';
          } else if (choice.textContent.includes('ChatGPT-3.5-turbo')) {
            selectedModel = 'gpt-3.5-turbo';
            $currentModel.textContent = 'ChatGPT-3.5-turbo';
          }

          resolve(selectedModel);
        }
      }

      modelOptions.forEach(option => option.addEventListener('click', handleModelChoice));
      retryButton.addEventListener('click', handleModelChoice);
    });
  }

  // Funci√≥n para cambiar el modelo
  async function changeModel() {
    // Desactivar la entrada de chat mientras se cambia el modelo
    $chatInput.setAttribute('disabled', '');
    $sendMessage.setAttribute('disabled', '');

    selectedModel = await showModelOptions();

    // Reinicializar el engine
    engine = null;
    isEngineInitializing = false;

    // Limpiar los mensajes anteriores
    messages = [];
    $chatMessages.innerHTML = '';

    await addMessage("He cambiado al modelo " + $currentModel.textContent + ". ¬øEn qu√© puedo ayudarte?", 'bot');

    // Reactivar la entrada de chat
    enableChat();
  }

  // Inicializar el engine de forma perezosa
  async function initializeEngine() {
    if (engine && engine.model === selectedModel) return engine;
    if (isEngineInitializing) {
      while (isEngineInitializing) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      return engine;
    }

    isEngineInitializing = true;
    showLoadingIndicator();

    try {
      if (selectedModel === 'Llama-3.2-1B-Instruct-q4f32_1-MLC') {
        engine = await CreateWebWorkerMLCEngine(
          new Worker('/static/js/worker.js', { type: 'module' }),
          selectedModel,
          {
            initProgressCallback: (info) => {
              console.log('Init progress:', info);
              updateLoadingIndicator(info.text);
            }
          }
        );
      } else {
        // Para ChatGPT, no necesitamos inicializar un engine local
        engine = { model: 'gpt-3.5-turbo' };
      }
    } catch (error) {
      console.error('Error initializing engine:', error);
      addMessage("Lo siento, ha ocurrido un error al inicializar el chatbot. Por favor, intenta recargar la p√°gina.", 'bot');
    } finally {
      isEngineInitializing = false;
      hideLoadingIndicator();
    }

    return engine;
  }

  // Funciones para manejar el indicador de carga
  function showLoadingIndicator() {
    const progressText = $('#init-progress-text');
    progressText.textContent = "Cargando el modelo, por favor espera...";
    progressText.classList.remove('hidden');
  }

  function updateLoadingIndicator(text) {
    const progressText = $('#init-progress-text');
    progressText.textContent = text;
  }

  function hideLoadingIndicator() {
    const progressText = $('#init-progress-text');
    progressText.textContent = "Carga completada";
    setTimeout(() => {
      progressText.classList.add('hidden');
    }, 3000);
  }

  // Habilitar el chat cuando el modelo est√© listo
  function enableChat() {
    $chatInput.removeAttribute('disabled');
    $sendMessage.removeAttribute('disabled');
  }

  async function addMessage(text, sender) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col');

    if (sender === 'user') {
      messageElement.classList.add(
        'bg-blue-700',
        'dark:bg-indigo-700',
        'text-white',
        'ml-auto',
        'inline-block',
        'px-4',
        'py-2',
        'rounded-lg',
        'max-w-[60%]',
        'text-left',
        'font-semibold'
      );
      messageElement.innerHTML = `<p class="text-sm">${text}</p>`;
      $chatMessages.appendChild(messageElement);
    } else {
      messageElement.classList.add(
        'bg-gray-100',
        'dark:bg-[#0f1e41]',
        'mr-auto',
        'px-4',
        'py-2',
        'rounded-lg',
        'w-full',
        'max-w-[80%]',
        'font-semibold'
      );

      const botTextElement = document.createElement('p');
      botTextElement.classList.add('text-sm');
      messageElement.appendChild(botTextElement);

      $chatMessages.appendChild(messageElement);
      $chatMessages.scrollTop = $chatMessages.scrollHeight;

      await typeMessage(botTextElement, text);
    }

    $chatMessages.scrollTop = $chatMessages.scrollHeight;
  }

  // Funci√≥n para animar el texto letra por letra
  function typeMessage(element, text, delay = 50) {
    return new Promise((resolve) => {
      let index = 0;

      function typeNextLetter() {
        if (index < text.length) {
          element.textContent += text.charAt(index);
          index++;
          setTimeout(typeNextLetter, delay);
        } else {
          resolve();
        }
      }

      typeNextLetter();
    });
  }

  // Funci√≥n para llamar a la API de OpenAI (versi√≥n actual)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Comprueba si este cookie comienza con el nombre que buscamos
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function callOpenAIAPI(messages) {
    const csrfToken = getCookie('csrftoken');  // Obt√©n el token CSRF

    const response = await fetch('/core/api/chat/', {
      method: 'POST', // Aseg√∫rate de usar el m√©todo POST
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,  // Incluye el token CSRF aqu√≠
      },
      body: JSON.stringify({
        messages: messages,
      }),
    });

    if (!response.ok) {
      throw new Error('Error al llamar a la API de OpenAI');
    }

    const data = await response.json();
    return data.choices[0].message.content;
  }

  // Enviar el mensaje del usuario
  async function sendMessage() {
    const messageText = $chatInput.value.trim();
    if (messageText === '') return;

    $chatInput.value = '';
    await addMessage(messageText, 'user');
    $chatInput.setAttribute('disabled', '');
    $sendMessage.setAttribute('disabled', '');

    const userMessage = { role: 'user', content: messageText };
    messages.push(userMessage);

    try {
      // Primero, buscar en el JSON
      let reply = findAnswerInJSON(messageText);

      if (reply) {
        // Si se encuentra una respuesta en el JSON, usarla directamente
        await addMessage(reply, 'bot');
      } else {
        // Si no se encuentra en el JSON, usar el modelo seleccionado
        engine = await initializeEngine();

        if (selectedModel === 'Llama-3.2-1B-Instruct-q4f32_1-MLC') {
          const chunks = await engine.chat.completions.create({
            messages,
            stream: true
          });

          reply = '';

          const botMessageElement = document.createElement('div');
          botMessageElement.classList.add('mb-4', 'p-3', 'rounded-lg', 'flex', 'flex-col', 'bg-gray-100', 'dark:bg-[#0f1e41]', 'mr-auto', 'px-4', 'py-2', 'rounded-lg', 'w-full', 'max-w-[80%]', 'font-semibold');
          const botTextElement = document.createElement('p');
          botTextElement.classList.add('text-sm');
          botMessageElement.appendChild(botTextElement);
          $chatMessages.appendChild(botMessageElement);
          $chatMessages.scrollTop = $chatMessages.scrollHeight;

          for await (const chunk of chunks) {
            const content = chunk.choices[0]?.delta?.content ?? '';
            reply += content;
            botTextElement.textContent += content;
            $chatMessages.scrollTop = $chatMessages.scrollHeight;
          }
        } else if (selectedModel === 'gpt-3.5-turbo') {
          reply = await callOpenAIAPI(messages);
          await addMessage(reply, 'bot');
        }
      }

      messages.push({ role: 'assistant', content: reply });
    } catch (error) {
      console.error('Error generating response:', error);
      addMessage("Lo siento, ha ocurrido un error al generar la respuesta. Por favor, intenta de nuevo.", 'bot');
    }

    $chatInput.removeAttribute('disabled');
    $sendMessage.removeAttribute('disabled');
    $chatInput.focus();
  }

  // Event Listeners
  if ($openChat && $closeChat) {
    $openChat.addEventListener('click', () => {
      $chatbot.classList.remove('hidden', 'opacity-0', 'translate-y-5');
      $openChat.classList.add('hidden');
      initializeChatbot();
    });

    $closeChat.addEventListener('click', () => {
      $chatbot.classList.add('hidden', 'opacity-0', 'translate-y-5');
      $openChat.classList.remove('hidden');
      $chatMessages.innerHTML = '';
      messages = [];
      selectedModel = null;
      engine = null;
      $currentModel.textContent = 'Ninguno';  // Resetea el modelo mostrado
    });

    $sendMessage.addEventListener('click', sendMessage);
    $chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // Nuevo event listener para cambiar el modelo
    $selectedModelDiv.addEventListener('click', changeModel);
  }
</script>
